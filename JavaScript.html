<script>
    let currentStudentName = '';

    function showLoading() { document.getElementById('loading').style.display = 'block'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }

    function searchStudent() {
        const name = document.getElementById('search-name').value.trim();
        if (!name) {
            alert('학생 이름을 입력해주세요.');
            return;
        }
        showLoading();
        google.script.run
            .withSuccessHandler(displayStudentDetails)
            .withFailureHandler(handleError)
            .getStudentDetails(name);
    }

    function showAddStudentForm() {
        document.getElementById('search-section').style.display = 'none';
        document.getElementById('add-student-form').style.display = 'block';
        document.getElementById('new-student-name').value = document.getElementById('search-name').value;
    }

    function hideAddStudentForm() {
        document.getElementById('search-section').style.display = 'block';
        document.getElementById('add-student-form').style.display = 'none';
        document.getElementById('new-student-name').value = '';
    }

    function addStudent() {
        const name = document.getElementById('new-student-name').value.trim();
        if (!name) {
            alert('학생 이름을 입력해주세요.');
            return;
        }
        showLoading();
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                alert(response.message);
                if (response.success) {
                    hideAddStudentForm();
                    document.getElementById('search-name').value = name;
                    searchStudent();
                }
            })
            .withFailureHandler(handleError)
            .addStudent({ name: name });
    }

    function displayStudentDetails(details) {
        hideLoading();
        if (!details) {
            if (confirm('해당 학생을 찾을 수 없습니다. 신규 학생으로 추가하시겠습니까?')) {
                showAddStudentForm();
            }
            return;
        }

        currentStudentName = details.info.name;
        document.getElementById('search-section').style.display = 'none';
        document.getElementById('add-student-form').style.display = 'none';
        document.getElementById('student-details').style.display = 'block';

        document.getElementById('student-name-header').innerText = `${details.info.name} 학생 정보`;
        document.getElementById('teacher').value = details.info.teacher;
        document.getElementById('materials').value = details.info.materials;
        document.getElementById('progress-history').innerText = details.info.progress;
        document.getElementById('new-progress').value = '';
        document.getElementById('notes').value = details.info.notes;

        const summaryTbody = document.getElementById('attendance-summary-table').getElementsByTagName('tbody')[0];
        summaryTbody.innerHTML = '';
        if (details.attendanceSummary && details.attendanceSummary.length > 0) {
            details.attendanceSummary.forEach(summary => {
                const row = summaryTbody.insertRow();
                const cellMonth = row.insertCell();
                const cellCount = row.insertCell();
                
                cellMonth.innerText = summary.month;
                cellCount.innerText = `${summary.count}회 / 4회`;
                
                if (summary.count >= 4) {
                    cellCount.style.color = 'green';
                    cellCount.style.fontWeight = 'bold';
                }
            });
        } else {
            const row = summaryTbody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 2;
            cell.innerText = '출석 기록이 없습니다.';
            cell.style.textAlign = 'center';
        }

        const attendanceTbody = document.getElementById('attendance-table').getElementsByTagName('tbody')[0];
        attendanceTbody.innerHTML = '';
        if(details.attendance) details.attendance.forEach(att => addAttendanceRow(att.date, att.status));

        const paymentTbody = document.getElementById('payment-table').getElementsByTagName('tbody')[0];
        paymentTbody.innerHTML = '';
        if(details.payment) details.payment.forEach(pay => addPaymentRow(pay.month, pay.status));
    }

    function addAttendanceRow(date = '', status = '출석') {
        const table = document.getElementById('attendance-table').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow(0);
        newRow.innerHTML = `
            <td><input type="date" value="${formatDate(date)}"></td>
            <td>
                <select>
                    <option value="출석" ${status === '출석' ? 'selected' : ''}>출석</option>
                    <option value="결석" ${status === '결석' ? 'selected' : ''}>결석</option>
                    <option value="보강" ${status === '보강' ? 'selected' : ''}>보강</option>
                </select>
            </td>
            <td><button type="button" class="btn-delete" onclick="deleteRow(this)">삭제</button></td>
        `;
    }

    function addPaymentRow(month = '', status = '미납') {
        const table = document.getElementById('payment-table').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow(0);
        newRow.innerHTML = `
            <td><input type="text" placeholder="예: 2025-07" value="${month}"></td>
            <td>
                <select>
                    <option value="완납" ${status === '완납' ? 'selected' : ''}>완납</option>
                    <option value="미납" ${status === '미납' ? 'selected' : ''}>미납</option>
                    <option value="상담" ${status === '상담' ? 'selected' : ''}>상담</option>
                </select>
            </td>
            <td><button type="button" class="btn-delete" onclick="deleteRow(this)">삭제</button></td>
        `;
    }
    
    function deleteRow(btn) {
        const row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function saveChanges() {
        if (!confirm('정말로 변경사항을 저장하시겠습니까?')) return;
        
        showLoading();
        const details = {
            name: currentStudentName,
            teacher: document.getElementById('teacher').value,
            materials: document.getElementById('materials').value,
            newProgress: document.getElementById('new-progress').value,
            notes: document.getElementById('notes').value,
            attendance: [],
            payment: []
        };

        const attendanceRows = document.getElementById('attendance-table').getElementsByTagName('tbody')[0].rows;
        for (let row of attendanceRows) {
            const dateInput = row.cells[0].getElementsByTagName('input')[0].value;
            if(dateInput) {
                 details.attendance.push({
                    date: dateInput,
                    status: row.cells[1].getElementsByTagName('select')[0].value
                });
            }
        }

        const paymentRows = document.getElementById('payment-table').getElementsByTagName('tbody')[0].rows;
        for (let row of paymentRows) {
            const monthInput = row.cells[0].getElementsByTagName('input')[0].value;
            if(monthInput) {
                details.payment.push({
                    month: monthInput,
                    status: row.cells[1].getElementsByTagName('select')[0].value
                });
            }
        }

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                alert(response.message);
                if (response.success) {
                    searchStudent(); 
                }
            })
            .withFailureHandler(handleError)
            .updateStudentDetails(details);
    }

    function goBackToSearch() {
        document.getElementById('student-details').style.display = 'none';
        document.getElementById('search-section').style.display = 'block';
        document.getElementById('search-name').value = '';
        currentStudentName = '';
    }

    function handleError(error) {
        hideLoading();
        alert('오류가 발생했습니다: ' + error.message);
    }

    function formatDate(dateString) {
        if (!dateString) return new Date().toISOString().slice(0, 10);
        try {
            return new Date(dateString).toISOString().slice(0, 10);
        } catch (e) {
            return '';
        }
    }

    document.getElementById('search-name').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            searchStudent();
        }
    });
</script>