<script>
    let currentStudentId = null;
    let searchedName = '';

    function showLoading() { document.getElementById('loading').style.display = 'block'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }

    function showSection(sectionId) {
        ['search-section', 'search-results-section', 'add-student-section', 'student-details'].forEach(id => {
            document.getElementById(id).style.display = (id === sectionId) ? 'block' : 'none';
        });
    }

    function searchStudents() {
        searchedName = document.getElementById('search-name').value.trim();
        if (!searchedName) {
            alert('학생 이름을 입력해주세요.');
            return;
        }
        showLoading();
        google.script.run
            .withSuccessHandler(displaySearchResults)
            .withFailureHandler(handleError)
            .searchStudentsByName(searchedName);
    }

    function displaySearchResults(results) {
        hideLoading();
        if (results.length === 0) {
            document.getElementById('new-student-name-confirm').innerText = `'${searchedName}'`;
            showSection('add-student-section');
        } else if (results.length === 1) {
            getStudentDetails(results[0].id);
        } else {
            const list = document.getElementById('search-results-list');
            list.innerHTML = '';
            results.forEach(student => {
                const item = document.createElement('li');
                item.textContent = `${student.name} (담당: ${student.teacher || '미지정'}, ID: ${student.id})`;
                item.style.cursor = 'pointer';
                item.onclick = () => getStudentDetails(student.id);
                list.appendChild(item);
            });
            showSection('search-results-section');
        }
    }

    /**
     * [구조 변경] addStudent는 이제 성공 시 상세 정보(details)를 직접 반환합니다.
     */
    function addStudent() {
        showLoading();
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                alert(response.message);
                if (response.success) {
                    // 더 이상 getStudentDetails를 호출하지 않고, 반환된 details를 바로 사용합니다.
                    displayStudentDetails(response.details);
                }
            })
            .withFailureHandler(handleError)
            .addStudent({ name: searchedName });
    }

    function getStudentDetails(id) {
        showLoading();
        google.script.run
            .withSuccessHandler(displayStudentDetails)
            .withFailureHandler(handleError)
            .getStudentDetails(id);
    }

    function displayStudentDetails(details) {
        hideLoading();
        if (!details) {
            alert('학생 정보를 표시하는 데 실패했습니다. (details is null)');
            goBackToSearch();
            return;
        }

        currentStudentId = details.info.id;
        document.getElementById('student-name-header').innerText = `${details.info.name} (ID: ${details.info.id}) 학생 정보`;
        document.getElementById('name').value = details.info.name;
        document.getElementById('teacher').value = details.info.teacher;
        document.getElementById('materials').value = details.info.materials;
        document.getElementById('progress-history').innerText = details.info.progress;
        document.getElementById('new-progress').value = '';
        document.getElementById('notes').value = details.info.notes;

        const summaryTbody = document.getElementById('attendance-summary-table').getElementsByTagName('tbody')[0];
        summaryTbody.innerHTML = '';
        if (details.attendanceSummary && details.attendanceSummary.length > 0) {
            details.attendanceSummary.forEach(summary => {
                const row = summaryTbody.insertRow();
                row.innerHTML = `<td>${summary.month}</td><td style="color: ${summary.count >= 4 ? 'green' : 'inherit'}; font-weight: ${summary.count >= 4 ? 'bold' : 'normal'};">${summary.count}회 / 4회</td>`;
            });
        } else {
            summaryTbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">출석 기록이 없습니다.</td></tr>';
        }

        const attendanceTbody = document.getElementById('attendance-table').getElementsByTagName('tbody')[0];
        attendanceTbody.innerHTML = '';
        if(details.attendance) details.attendance.forEach(att => addAttendanceRow(att.date, att.status));

        const paymentTbody = document.getElementById('payment-table').getElementsByTagName('tbody')[0];
        paymentTbody.innerHTML = '';
        if(details.payment) details.payment.forEach(pay => addPaymentRow(pay.month, pay.status));
        
        showSection('student-details');
    }

    function saveChanges() {
        if (!confirm('정말로 변경사항을 저장하시겠습니까?')) return;
        
        showLoading();
        const details = {
            id: currentStudentId,
            name: document.getElementById('name').value,
            teacher: document.getElementById('teacher').value,
            materials: document.getElementById('materials').value,
            newProgress: document.getElementById('new-progress').value,
            notes: document.getElementById('notes').value,
            attendance: [],
            payment: []
        };

        Array.from(document.getElementById('attendance-table').getElementsByTagName('tbody')[0].rows).forEach(row => {
            const dateInput = row.cells[0].querySelector('input').value;
            if(dateInput) details.attendance.push({ date: dateInput, status: row.cells[1].querySelector('select').value });
        });

        Array.from(document.getElementById('payment-table').getElementsByTagName('tbody')[0].rows).forEach(row => {
            const monthInput = row.cells[0].querySelector('input').value;
            if(monthInput) details.payment.push({ month: monthInput, status: row.cells[1].querySelector('select').value });
        });

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                alert(response.message);
                if (response.success) {
                    getStudentDetails(currentStudentId);
                }
            })
            .withFailureHandler(handleError)
            .updateStudentDetails(details);
    }

    function goBackToSearch() {
        document.getElementById('search-name').value = '';
        currentStudentId = null;
        searchedName = '';
        showSection('search-section');
    }

    function addAttendanceRow(date = '', status = '출석') {
        const newRow = document.getElementById('attendance-table').getElementsByTagName('tbody')[0].insertRow(0);
        newRow.innerHTML = `<td><input type="date" value="${formatDate(date)}"></td><td><select><option value="출석" ${status === '출석' ? 'selected' : ''}>출석</option><option value="결석" ${status === '결석' ? 'selected' : ''}>결석</option><option value="보강" ${status === '보강' ? 'selected' : ''}>보강</option></select></td><td><button type="button" class="btn-delete" onclick="deleteRow(this)">삭제</button></td>`;
    }
    function addPaymentRow(month = '', status = '미납') {
        const newRow = document.getElementById('payment-table').getElementsByTagName('tbody')[0].insertRow(0);
        newRow.innerHTML = `<td><input type="text" placeholder="예: 2025-07" value="${month}"></td><td><select><option value="완납" ${status === '완납' ? 'selected' : ''}>완납</option><option value="미납" ${status === '미납' ? 'selected' : ''}>미납</option><option value="상담" ${status === '상담' ? 'selected' : ''}>상담</option></select></td><td><button type="button" class="btn-delete" onclick="deleteRow(this)">삭제</button></td>`;
    }
    function deleteRow(btn) { btn.closest('tr').remove(); }
    function handleError(error) { hideLoading(); alert('오류가 발생했습니다: ' + error.message); }
    function formatDate(dateString) {
        if (!dateString) return new Date().toISOString().slice(0, 10);
        try { return new Date(dateString).toISOString().slice(0, 10); } catch (e) { return ''; }
    }
    document.getElementById('search-name').addEventListener('keyup', e => e.key === 'Enter' && searchStudents());
</script>
