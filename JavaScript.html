<script>
    let currentStudentName = '';

    // 로딩 화면 표시/숨김
    function showLoading() { document.getElementById('loading').style.display = 'block'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }

    // 학생 검색
    function searchStudent() {
        const name = document.getElementById('search-name').value.trim();
        if (!name) {
            alert('학생 이름을 입력해주세요.');
            return;
        }
        showLoading();
        google.script.run
            .withSuccessHandler(displayStudentDetails)
            .withFailureHandler(handleError)
            .getStudentDetails(name);
    }

    // 신규 학생 추가 폼 표시
    function showAddStudentForm() {
        document.getElementById('search-section').style.display = 'none';
        document.getElementById('add-student-form').style.display = 'block';
        document.getElementById('new-student-name').value = document.getElementById('search-name').value;
    }

    // 신규 학생 추가 폼 숨김
    function hideAddStudentForm() {
        document.getElementById('search-section').style.display = 'block';
        document.getElementById('add-student-form').style.display = 'none';
        document.getElementById('new-student-name').value = '';
    }

    // 신규 학생 추가 실행
    function addStudent() {
        const name = document.getElementById('new-student-name').value.trim();
        if (!name) {
            alert('학생 이름을 입력해주세요.');
            return;
        }
        showLoading();
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                alert(response.message);
                if (response.success) {
                    hideAddStudentForm();
                    document.getElementById('search-name').value = name;
                    searchStudent(); // 추가 후 바로 검색
                }
            })
            .withFailureHandler(handleError)
            .addStudent({ name: name });
    }

    // 학생 상세 정보 표시
    function displayStudentDetails(details) {
        hideLoading();
        if (!details) {
            if (confirm('해당 학생을 찾을 수 없습니다. 신규 학생으로 추가하시겠습니까?')) {
                showAddStudentForm();
            }
            return;
        }

        currentStudentName = details.info.name;
        document.getElementById('search-section').style.display = 'none';
        document.getElementById('add-student-form').style.display = 'none';
        document.getElementById('student-details').style.display = 'block';

        document.getElementById('student-name-header').innerText = `${details.info.name} 학생 정보`;
        document.getElementById('teacher').value = details.info.teacher;
        document.getElementById('materials').value = details.info.materials;
        document.getElementById('progress').value = details.info.progress;
        document.getElementById('notes').value = details.info.notes;

        const attendanceTbody = document.getElementById('attendance-table').getElementsByTagName('tbody')[0];
        attendanceTbody.innerHTML = '';
        if(details.attendance) details.attendance.forEach(att => addAttendanceRow(att.date, att.status));

        const paymentTbody = document.getElementById('payment-table').getElementsByTagName('tbody')[0];
        paymentTbody.innerHTML = '';
        if(details.payment) details.payment.forEach(pay => addPaymentRow(pay.month, pay.status));
    }

    // 출석 기록 행 추가
    function addAttendanceRow(date = '', status = '출석') {
        const table = document.getElementById('attendance-table').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow(0); // 항상 맨 위에 추가
        newRow.innerHTML = `
            <td><input type="date" value="${formatDate(date)}"></td>
            <td>
                <select>
                    <option value="출석" ${status === '출석' ? 'selected' : ''}>출석</option>
                    <option value="결석" ${status === '결석' ? 'selected' : ''}>결석</option>
                    <option value="보강" ${status === '보강' ? 'selected' : ''}>보강</option>
                </select>
            </td>
            <td><button type="button" class="btn-delete" onclick="deleteRow(this)">삭제</button></td>
        `;
    }

    // 교육비 납부 행 추가
    function addPaymentRow(month = '', status = '미납') {
        const table = document.getElementById('payment-table').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow(0); // 항상 맨 위에 추가
        newRow.innerHTML = `
            <td><input type="text" placeholder="예: 2025-07" value="${month}"></td>
            <td>
                <select>
                    <option value="완납" ${status === '완납' ? 'selected' : ''}>완납</option>
                    <option value="미납" ${status === '미납' ? 'selected' : ''}>미납</option>
                    <option value="상담" ${status === '상담' ? 'selected' : ''}>상담</option>
                </select>
            </td>
            <td><button type="button" class="btn-delete" onclick="deleteRow(this)">삭제</button></td>
        `;
    }
    
    // 행 삭제
    function deleteRow(btn) {
        const row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    // 변경 사항 저장
    function saveChanges() {
        if (!confirm('정말로 변경사항을 저장하시겠습니까?')) return;
        
        showLoading();
        const details = {
            name: currentStudentName,
            teacher: document.getElementById('teacher').value,
            materials: document.getElementById('materials').value,
            progress: document.getElementById('progress').value,
            notes: document.getElementById('notes').value,
            attendance: [],
            payment: []
        };

        const attendanceRows = document.getElementById('attendance-table').getElementsByTagName('tbody')[0].rows;
        for (let row of attendanceRows) {
            const dateInput = row.cells[0].getElementsByTagName('input')[0].value;
            if(dateInput) { // 날짜가 입력된 경우에만 추가
                 details.attendance.push({
                    date: dateInput,
                    status: row.cells[1].getElementsByTagName('select')[0].value
                });
            }
        }

        const paymentRows = document.getElementById('payment-table').getElementsByTagName('tbody')[0].rows;
        for (let row of paymentRows) {
            const monthInput = row.cells[0].getElementsByTagName('input')[0].value;
            if(monthInput) { // 납부월이 입력된 경우에만 추가
                details.payment.push({
                    month: monthInput,
                    status: row.cells[1].getElementsByTagName('select')[0].value
                });
            }
        }

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                alert(response.message);
                if (response.success) {
                    goBackToSearch();
                }
            })
            .withFailureHandler(handleError)
            .updateStudentDetails(details);
    }

    // 검색 화면으로 돌아가기
    function goBackToSearch() {
        document.getElementById('student-details').style.display = 'none';
        document.getElementById('search-section').style.display = 'block';
        document.getElementById('search-name').value = '';
        currentStudentName = '';
    }

    // 오류 처리
    function handleError(error) {
        hideLoading();
        alert('오류가 발생했습니다: ' + error.message);
    }

    // 날짜 형식을 YYYY-MM-DD로 변환
    function formatDate(dateString) {
        if (!dateString) return new Date().toISOString().slice(0, 10);
        try {
            return new Date(dateString).toISOString().slice(0, 10);
        } catch (e) {
            return '';
        }
    }

    // Enter 키로 검색 실행
    document.getElementById('search-name').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            searchStudent();
        }
    });
</script>
