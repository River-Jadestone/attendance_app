<!-- javascript.html -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // --- UI 요소 변수 선언 ---
  const searchForm = document.getElementById('search-form');
  const searchInput = document.getElementById('search-name');
  const resultsDiv = document.getElementById('search-results');
  const loader = document.getElementById('loader');
  const addNewStudentBtn = document.getElementById('add-new-student-btn');
  const saveStudentBtn = document.getElementById('save-student-btn');
  
  // 결제 관련
  const openPaymentModalBtn = document.getElementById('open-payment-modal-btn');
  const recordPaymentBtn = document.getElementById('record-payment-btn');
  const subjectSelect = document.getElementById('subject-select');
  const monthsSelect = document.getElementById('months-select');
  const calculatedFeeSpan = document.getElementById('calculated-fee');
  const discountDetailsSpan = document.getElementById('discount-details');

  // 출결 관련
  const recordAttendanceBtn = document.getElementById('record-attendance-btn');
  const attendanceStatusSelect = document.getElementById('attendance-status');
  const progressDetailsDiv = document.getElementById('progress-details');

  // 캘린더 관련
  let calendarEl = document.getElementById('calendar-container');
  let calendar;
  let currentStudentForCalendar = {};

  // --- 이벤트 리스너 등록 ---
  searchForm.addEventListener('submit', handleSearch);
  addNewStudentBtn.addEventListener('click', () => $('#add-student-modal').modal('show'));
  saveStudentBtn.addEventListener('click', saveNewStudent);
  openPaymentModalBtn.addEventListener('click', openPaymentModal);
  recordPaymentBtn.addEventListener('click', recordPayment);
  recordAttendanceBtn.addEventListener('click', recordAttendance);
  
  // 실시간 금액 계산 이벤트
  subjectSelect.addEventListener('change', updateCalculatedFee);
  monthsSelect.addEventListener('change', updateCalculatedFee);

  attendanceStatusSelect.addEventListener('change', () => {
    progressDetailsDiv.style.display = (attendanceStatusSelect.value === '출석') ? 'block' : 'none';
  });

  // --- 함수 정의 ---
  function handleSearch(e) {
    e.preventDefault();
    loader.style.display = 'block';
    resultsDiv.innerHTML = '';
    google.script.run.withSuccessHandler(displayResults).withFailureHandler(showError).searchStudent(searchInput.value.trim());
  }

  function displayResults(students) {
    loader.style.display = 'none';
    if (students.length === 0) {
      resultsDiv.innerHTML = '<p class="text-center">검색 결과가 없습니다.</p>';
      return;
    }
    let table = '<table id="results-table" class="table table-hover"><thead><tr><th>학생ID</th><th>이름</th><th>나이</th><th>학교</th><th>작업</th></tr></thead><tbody>';
    students.forEach(student => {
      table += `<tr><td>${student.학생ID}</td><td>${student.이름}</td><td>${student.나이}</td><td>${student.학교}</td><td><button class="btn btn-sm btn-info" onclick="viewDetails('${student.학생ID}')">상세보기</button></td></tr>`;
    });
    table += '</tbody></table>';
    resultsDiv.innerHTML = table;
  }

  function saveNewStudent() {
    const studentInfo = { name: $('#new-name').val().trim(), age: $('#new-age').val().trim(), school: $('#new-school').val().trim() };
    if (!studentInfo.name || !studentInfo.age || !studentInfo.school) { alert('모든 필드를 입력해주세요.'); return; }
    this.disabled = true;
    google.script.run.withSuccessHandler(response => {
      alert(response.message);
      if (response.success) {
        $('#add-student-modal').modal('hide');
        searchInput.value = studentInfo.name;
        searchForm.dispatchEvent(new Event('submit'));
      }
      saveStudentBtn.disabled = false;
    }).withFailureHandler(showError).addStudent(studentInfo);
  }

  window.viewDetails = function(studentId) {
    $('#student-details-modal').modal('show');
    $('#details-loader').show();
    $('#details-content').hide();
    google.script.run.withSuccessHandler(displayStudentDetails).withFailureHandler(showError).getStudentDetails(studentId);
  };

  function displayStudentDetails(data) {
    if (data.error) { showError(data); $('#student-details-modal').modal('hide'); return; }
    $('#details-loader').hide();
    $('#details-content').show();
    
    const info = data.info;
    currentStudentForCalendar = { id: info.학생ID, name: info.이름 };

    $('#details-modal-title').text(`${info.이름} (${info.학생ID}) 학생 상세 정보`);
    openPaymentModalBtn.setAttribute('data-student-id', info.학생ID);

    $('#info-content').html(`<p><strong>나이:</strong> ${info.나이}</p><p><strong>학교:</strong> ${info.학교}</p><p><strong>가족 그룹 ID:</strong> ${info['가족 그룹 ID']}</p>`);
    $('#payments-content').html(createTable(data.payments, ['납부일', '납부 금액', '결제 수단', '비고']));
    $('#progress-content').html(createTable(data.progress, ['수업 날짜', '과목ID', '수업 내용', '수업 선생님']));
    
    if (calendar) calendar.destroy();
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth', locale: 'ko',
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
      events: data.attendance,
      dateClick: (info) => openAttendanceModal(info.dateStr)
    });
    calendar.render();
  }

  function openPaymentModal() {
    const studentId = this.getAttribute('data-student-id');
    $('#payment-student-id').val(studentId);
    updateCalculatedFee(); // 예상 금액 초기화
    google.script.run.withSuccessHandler(subjects => {
      subjectSelect.innerHTML = '<option value="">과목을 선택하세요</option>';
      subjects.forEach(s => subjectSelect.innerHTML += `<option value="${s.과목ID}">${s.과목명} (월 ${s.월수강료}원)</option>`);
      $('#payment-modal').modal('show');
    }).withFailureHandler(showError).getSubjects();
  }

  function updateCalculatedFee() {
    const data = {
      studentId: $('#payment-student-id').val(),
      subjectId: subjectSelect.value,
      months: monthsSelect.value
    };

    if (!data.subjectId) {
      calculatedFeeSpan.textContent = '0원';
      discountDetailsSpan.textContent = '';
      return;
    }

    calculatedFeeSpan.textContent = '계산 중...';
    google.script.run.withSuccessHandler(result => {
      if (result.success) {
        calculatedFeeSpan.textContent = result.finalAmount.toLocaleString('ko-KR') + '원';
        discountDetailsSpan.textContent = result.details || '';
      } else {
        calculatedFeeSpan.textContent = '계산 오류';
        discountDetailsSpan.textContent = result.message;
      }
    }).withFailureHandler(showError).calculateTuitionFee(data);
  }

  function recordPayment() {
    const paymentData = { studentId: $('#payment-student-id').val(), studentName: currentStudentForCalendar.name, subjectId: subjectSelect.value, months: monthsSelect.value, paymentMethod: $('#payment-method').val(), cardCompany: $('#card-company').val() };
    if (!paymentData.subjectId) { alert('과목을 선택해주세요.'); return; }
    this.disabled = true;
    google.script.run.withSuccessHandler(response => {
      alert(response.message);
      if (response.success) {
        $('#payment-modal').modal('hide');
        $('#student-details-modal').modal('hide');
        searchForm.dispatchEvent(new Event('submit'));
      }
      recordPaymentBtn.disabled = false;
    }).withFailureHandler(showError).calculateAndRecordPayment(paymentData);
  }

  function openAttendanceModal(clickedDate) {
    $('#attendance-student-id').val(currentStudentForCalendar.id);
    $('#attendance-student-name').val(currentStudentForCalendar.name);
    $('#class-date').val(clickedDate);

    google.script.run.withSuccessHandler(subjects => {
      const subjectSelect = $('#progress-subject');
      subjectSelect.html('<option value="">과목을 선택하세요</option>');
      subjects.forEach(s => subjectSelect.append(`<option value="${s.과목ID}">${s.과목명}</option>`));
      $('#attendance-modal').modal('show');
    }).withFailureHandler(showError).getSubjects();
  }

  function recordAttendance() {
    const recordData = { studentId: $('#attendance-student-id').val(), studentName: $('#attendance-student-name').val(), classDate: $('#class-date').val(), attendanceStatus: $('#attendance-status').val(), subjectId: $('#progress-subject').val(), classContent: $('#class-content').val(), teacherName: $('#teacher-name').val() };
    if (!recordData.classDate) { alert('수업 날짜를 선택해주세요.'); return; }
    if (recordData.attendanceStatus === '출석' && !recordData.subjectId) { alert('과목을 선택해주세요.'); return; }
    
    this.disabled = true;
    google.script.run.withSuccessHandler(response => {
      alert(response.message);
      if (response.success) {
        $('#attendance-modal').modal('hide');
        $('#student-details-modal').modal('hide');
        // 상세창을 닫았으므로, 다시 열었을 때 최신 정보를 보려면 검색을 다시 해야 함
        // viewDetails(recordData.studentId); // 이 방법도 가능
      }
      recordAttendanceBtn.disabled = false;
    }).withFailureHandler(showError).recordAttendanceAndProgress(recordData);
  }

  function showError(error) {
    $('.spinner-border').parent().hide();
    alert("오류가 발생했습니다: " + error.message);
    $('button').prop('disabled', false);
  }

  function createTable(data, headers) {
    if (!data || data.length === 0) return '<p>데이터가 없습니다.</p>';
    let table = '<table class="table table-striped table-bordered table-sm"><thead><tr>';
    headers.forEach(h => table += `<th>${h}</th>`);
    table += '</tr></thead><tbody>';
    data.forEach(row => {
      table += '<tr>';
      headers.forEach(h => table += `<td>${row[h] || ''}</td>`);
      table += '</tr>';
    });
    table += '</tbody></table>';
    return table;
  }
});
</script>
