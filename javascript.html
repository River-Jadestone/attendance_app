<!-- javascript.html (달력 기능 추가) -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // --- UI 요소 변수 선언 ---
  const searchForm = document.getElementById('search-form');
  const searchInput = document.getElementById('search-name');
  const resultsDiv = document.getElementById('search-results');
  const loader = document.getElementById('loader');
  const addNewStudentBtn = document.getElementById('add-new-student-btn');
  const saveStudentBtn = document.getElementById('save-student-btn');
  const openPaymentModalBtn = document.getElementById('open-payment-modal-btn');
  const recordPaymentBtn = document.getElementById('record-payment-btn');
  const recordAttendanceBtn = document.getElementById('record-attendance-btn');
  const attendanceStatusSelect = document.getElementById('attendance-status');
  const progressDetailsDiv = document.getElementById('progress-details');

  // --- 캘린더 관련 변수 ---
  let calendarEl = document.getElementById('calendar-container');
  let calendar;
  let currentStudentForCalendar = {};

  // --- 이벤트 리스너 등록 ---
  searchForm.addEventListener('submit', handleSearch);
  addNewStudentBtn.addEventListener('click', () => $('#add-student-modal').modal('show'));
  saveStudentBtn.addEventListener('click', saveNewStudent);
  openPaymentModalBtn.addEventListener('click', openPaymentModal);
  recordPaymentBtn.addEventListener('click', recordPayment);
  recordAttendanceBtn.addEventListener('click', recordAttendance);
  attendanceStatusSelect.addEventListener('change', () => {
    progressDetailsDiv.style.display = (attendanceStatusSelect.value === '출석') ? 'block' : 'none';
  });

  // --- 함수 정의 ---
  function handleSearch(e) {
    e.preventDefault();
    loader.style.display = 'block';
    resultsDiv.innerHTML = '';
    google.script.run.withSuccessHandler(displayResults).withFailureHandler(showError).searchStudent(searchInput.value.trim());
  }

  function displayResults(students) {
    loader.style.display = 'none';
    if (students.length === 0) {
      resultsDiv.innerHTML = '<p class="text-center">검색 결과가 없습니다.</p>';
      return;
    }
    let table = '<table id="results-table" class="table table-hover"><thead><tr><th>학생ID</th><th>이름</th><th>나이</th><th>학교</th><th>작업</th></tr></thead><tbody>';
    students.forEach(student => {
      table += `<tr><td>${student.학생ID}</td><td>${student.이름}</td><td>${student.나이}</td><td>${student.학교}</td><td><button class="btn btn-sm btn-info" onclick="viewDetails('${student.학생ID}')">상세보기</button></td></tr>`;
    });
    table += '</tbody></table>';
    resultsDiv.innerHTML = table;
  }

  function saveNewStudent() {
    const studentInfo = { name: $('#new-name').val().trim(), age: $('#new-age').val().trim(), school: $('#new-school').val().trim() };
    if (!studentInfo.name || !studentInfo.age || !studentInfo.school) { alert('모든 필드를 입력해주세요.'); return; }
    this.disabled = true;
    google.script.run.withSuccessHandler(response => {
      alert(response.message);
      if (response.success) {
        $('#add-student-modal').modal('hide');
        searchInput.value = studentInfo.name;
        searchForm.dispatchEvent(new Event('submit'));
      }
      saveStudentBtn.disabled = false;
    }).withFailureHandler(showError).addStudent(studentInfo);
  }

  window.viewDetails = function(studentId) {
    $('#student-details-modal').modal('show');
    $('#details-loader').show();
    $('#details-content').hide();
    google.script.run.withSuccessHandler(displayStudentDetails).withFailureHandler(showError).getStudentDetails(studentId);
  };

  function displayStudentDetails(data) {
    if (data.error) { showError(data); $('#student-details-modal').modal('hide'); return; }
    $('#details-loader').hide();
    $('#details-content').show();
    
    const info = data.info;
    currentStudentForCalendar = { id: info.학생ID, name: info.이름 }; // 현재 학생 정보 저장

    $('#details-modal-title').text(`${info.이름} (${info.학생ID}) 학생 상세 정보`);
    openPaymentModalBtn.setAttribute('data-student-id', info.학생ID);
    openPaymentModalBtn.setAttribute('data-student-name', info.이름);

    $('#info-content').html(`<p><strong>나이:</strong> ${info.나이}</p><p><strong>학교:</strong> ${info.학교}</p><p><strong>가족 그룹 ID:</strong> ${info['가족 그룹 ID']}</p>`);
    $('#payments-content').html(createTable(data.payments, ['납부일', '납부 금액', '결제 수단', '비고']));
    $('#progress-content').html(createTable(data.progress, ['수업 날짜', '과목ID', '수업 내용', '수업 선생님']));
    
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    // 수정된 부분: 달력 생성 및 렌더링
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    if (calendar) {
      calendar.destroy(); // 기존 달력 인스턴스 파괴
    }
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ko', // 한글 설정
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek'
      },
      events: data.attendance, // Code.gs에서 가공된 출결 데이터
      dateClick: function(info) {
        // 날짜를 클릭하면 출결 기록 모달 열기
        openAttendanceModal(info.dateStr);
      }
    });
    calendar.render();
  }

  function openPaymentModal() {
    $('#payment-student-id').val(this.getAttribute('data-student-id'));
    $('#payment-student-name').val(this.getAttribute('data-student-name'));
    google.script.run.withSuccessHandler(subjects => {
      const subjectSelect = $('#subject-select');
      subjectSelect.html('<option value="">과목을 선택하세요</option>');
      subjects.forEach(s => subjectSelect.append(`<option value="${s.과목ID}">${s.과목명} (월 ${s.월수강료}원)</option>`));
      $('#payment-modal').modal('show');
    }).withFailureHandler(showError).getSubjects();
  }

  function recordPayment() {
    const paymentData = { studentId: $('#payment-student-id').val(), studentName: $('#payment-student-name').val(), subjectId: $('#subject-select').val(), months: $('#months-select').val(), paymentMethod: $('#payment-method').val(), cardCompany: $('#card-company').val() };
    if (!paymentData.subjectId) { alert('과목을 선택해주세요.'); return; }
    this.disabled = true;
    google.script.run.withSuccessHandler(response => {
      alert(response.message);
      if (response.success) {
        $('#payment-modal').modal('hide');
        $('#student-details-modal').modal('hide');
        searchForm.dispatchEvent(new Event('submit'));
      }
      recordPaymentBtn.disabled = false;
    }).withFailureHandler(showError).calculateAndRecordPayment(paymentData);
  }

  // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
  // 수정된 부분: 날짜를 인자로 받도록 변경
  // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
  function openAttendanceModal(clickedDate) {
    $('#attendance-student-id').val(currentStudentForCalendar.id);
    $('#attendance-student-name').val(currentStudentForCalendar.name);
    $('#class-date').val(clickedDate); // 클릭된 날짜로 설정

    google.script.run.withSuccessHandler(subjects => {
      const subjectSelect = $('#progress-subject');
      subjectSelect.html('<option value="">과목을 선택하세요</option>');
      subjects.forEach(s => subjectSelect.append(`<option value="${s.과목ID}">${s.과목명}</option>`));
      $('#attendance-modal').modal('show');
    }).withFailureHandler(showError).getSubjects();
  }

  function recordAttendance() {
    const recordData = { studentId: $('#attendance-student-id').val(), studentName: $('#attendance-student-name').val(), classDate: $('#class-date').val(), attendanceStatus: $('#attendance-status').val(), subjectId: $('#progress-subject').val(), classContent: $('#class-content').val(), teacherName: $('#teacher-name').val() };
    if (!recordData.classDate) { alert('수업 날짜를 선택해주세요.'); return; }
    if (recordData.attendanceStatus === '출석' && !recordData.subjectId) { alert('과목을 선택해주세요.'); return; }
    
    this.disabled = true;
    google.script.run.withSuccessHandler(response => {
      alert(response.message);
      if (response.success) {
        $('#attendance-modal').modal('hide');
        $('#student-details-modal').modal('hide');
        searchForm.dispatchEvent(new Event('submit'));
      }
      recordAttendanceBtn.disabled = false;
    }).withFailureHandler(showError).recordAttendanceAndProgress(recordData);
  }

  function showError(error) {
    $('.spinner-border').parent().hide();
    alert("오류가 발생했습니다: " + error.message);
    $('button').prop('disabled', false);
  }

  function createTable(data, headers) {
    if (!data || data.length === 0) return '<p>데이터가 없습니다.</p>';
    let table = '<table class="table table-striped table-bordered table-sm"><thead><tr>';
    headers.forEach(h => table += `<th>${h}</th>`);
    table += '</tr></thead><tbody>';
    data.forEach(row => {
      table += '<tr>';
      headers.forEach(h => table += `<td>${row[h] || ''}</td>`);
      table += '</tr>';
    });
    table += '</tbody></table>';
    return table;
  }
});
</script>