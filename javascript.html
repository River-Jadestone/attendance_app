<!-- javascript.html -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchForm = document.getElementById('search-form');
  const searchInput = document.getElementById('search-name');
  const resultsDiv = document.getElementById('search-results');
  const loader = document.getElementById('loader');
  const addNewStudentBtn = document.getElementById('add-new-student-btn');
  const saveStudentBtn = document.getElementById('save-student-btn');
  const addStudentForm = document.getElementById('add-student-form');

  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const studentName = searchInput.value.trim();
    if (studentName) {
      loader.style.display = 'block';
      resultsDiv.innerHTML = '';
      google.script.run.withSuccessHandler(displayResults).withFailureHandler(showError).searchStudent(studentName);
    }
  });

  function displayResults(students) {
    loader.style.display = 'none';
    if (students.length === 0) {
      resultsDiv.innerHTML = '<p class="text-center">검색 결과가 없습니다.</p>';
      return;
    }
    let table = '<table id="results-table" class="table table-hover">';
    table += '<thead class="thead-light"><tr><th>학생ID</th><th>이름</th><th>나이</th><th>학교</th><th>작업</th></tr></thead><tbody>';
    students.forEach(student => {
      table += `<tr>
                  <td>${student.학생ID}</td>
                  <td>${student.이름}</td>
                  <td>${student.나이}</td>
                  <td>${student.학교}</td>
                  <td><button class="btn btn-sm btn-info" onclick="viewDetails('''${student.학생ID}''')">상세보기</button></td>
                </tr>`;
    });
    table += '</tbody></table>';
    resultsDiv.innerHTML = table;
  }

  addNewStudentBtn.addEventListener('click', function() {
    addStudentForm.reset();
    $('#add-student-modal').modal('show');
  });

  saveStudentBtn.addEventListener('click', function() {
    const studentInfo = {
      name: document.getElementById('new-name').value.trim(),
      age: document.getElementById('new-age').value.trim(),
      school: document.getElementById('new-school').value.trim()
    };
    if (!studentInfo.name || !studentInfo.age || !studentInfo.school) {
      alert('모든 필드를 입력해주세요.');
      return;
    }
    this.disabled = true;
    google.script.run.withSuccessHandler(function(response) {
      alert(response.message);
      if (response.success) {
        $('#add-student-modal').modal('hide');
        searchInput.value = studentInfo.name;
        searchForm.dispatchEvent(new Event('submit'));
      }
      saveStudentBtn.disabled = false;
    }).withFailureHandler(showError).addStudent(studentInfo);
  });

  function showError(error) {
    loader.style.display = 'none';
    document.getElementById('details-loader').style.display = 'none';
    alert("오류가 발생했습니다: " + error.message);
    if (saveStudentBtn.disabled) saveStudentBtn.disabled = false;
  }
  
  window.viewDetails = function(studentId) {
    $('#student-details-modal').modal('show');
    document.getElementById('details-loader').style.display = 'block';
    document.getElementById('details-content').style.display = 'none';
    
    google.script.run
      .withSuccessHandler(displayStudentDetails)
      .withFailureHandler(showError)
      .getStudentDetails(studentId);
  };

  function displayStudentDetails(data) {
    if (data.error) {
      showError(data);
      $('#student-details-modal').modal('hide');
      return;
    }

    document.getElementById('details-loader').style.display = 'none';
    document.getElementById('details-content').style.display = 'block';
    
    // 1. 기본 정보 채우기
    const info = data.info;
    document.getElementById('details-modal-title').innerText = `${info.이름} (${info.학생ID}) 학생 상세 정보`;
    let infoHtml = `<p><strong>나이:</strong> ${info.나이}</p>
                    <p><strong>학교:</strong> ${info.학교}</p>
                    <p><strong>가족 그룹 ID:</strong> ${info['가족 그룹 ID']}</p>`;
    document.getElementById('info-content').innerHTML = infoHtml;

    // 2. 납부 내역 테이블 생성
    document.getElementById('payments-content').innerHTML = createTable(data.payments, ['납부일', '납부 금액', '결제 수단', '비고']);
    
    // 3. 출결 현황 테이블 생성
    document.getElementById('attendance-content').innerHTML = createTable(data.attendance, ['출석 날짜', '출결 상태']);
    
    // 4. 수업 진도 테이블 생성
    document.getElementById('progress-content').innerHTML = createTable(data.progress, ['수업 날짜', '과목', '수업 내용', '수업 선생님']);

    // 첫 번째 탭을 활성화 상태로 리셋
    $('#details-content .nav-tabs a:first').tab('show');
  }

  function createTable(data, headers) {
    if (!data || data.length === 0) {
      return '<p>데이터가 없습니다.</p>';
    }
    let table = '<table class="table table-striped table-bordered table-sm"><thead><tr>';
    headers.forEach(h => table += `<th>${h}</th>`);
    table += '</tr></thead><tbody>';
    data.forEach(row => {
      table += '<tr>';
      headers.forEach(h => table += `<td>${row[h] || ''}</td>`);
      table += '</tr>';
    });
    table += '</tbody></table>';
    return table;
  }
});
</script>
